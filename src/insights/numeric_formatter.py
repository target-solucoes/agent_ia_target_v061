"""
Numeric Formatter - Formata√ß√£o de M√©tricas para LLM
Respons√°vel por transformar m√©tricas calculadas em prompts estruturados
"""

import json
from typing import Dict, Any


def gerar_prompt_insights(resumo_numerico: Dict[str, Any], tipo_grafico: str, max_insights: int = 5) -> str:
    """
    Gera prompt estruturado para a LLM criar insights inteligentes.
    
    Este prompt ser√° injetado no contexto do agente para guiar
    a gera√ß√£o de insights baseados no resumo num√©rico.
    
    Args:
        resumo_numerico: Dicion√°rio com m√©tricas calculadas
        tipo_grafico: Tipo do gr√°fico
        max_insights: N√∫mero m√°ximo de insights desejados (padr√£o: 5)
    
    Returns:
        String formatada com prompt para LLM
    """
    # Formatar resumo de forma leg√≠vel
    resumo_formatado = json.dumps(resumo_numerico, indent=2, ensure_ascii=False)

    # Template base do prompt
    prompt = f"""
üßÆ RESUMO NUM√âRICO ESTRUTURADO DISPON√çVEL

Voc√™ recebeu um resumo anal√≠tico pr√©-calculado com m√©tricas derivadas:

```json
{resumo_formatado}
```

## üéØ TAREFA: Gerar {max_insights} Insights Estrat√©gicos

Use o resumo num√©rico acima como BASE ANAL√çTICA para gerar insights n√£o-√≥bvios.

### ‚úÖ O QUE FAZER:
- Interpretar padr√µes e implica√ß√µes (n√£o apenas descrever n√∫meros)
- Usar m√©tricas derivadas (concentra√ß√£o_top3_pct, gap_1_2_pct, multiplo_1_vs_2, etc.)
- **‚ö†Ô∏è TRANSPAR√äNCIA OBRIGAT√ìRIA**: SEMPRE incluir valores absolutos que fundamentam os c√°lculos
  - Formato: "X% (Valor Base = R\\$ A / Total = R\\$ B)"
  - Exemplo: "20.5% (Top 5 = R\\$ 4.1M / Total = R\\$ 20.0M)"
- Focar em PROPOR√á√ïES e RELA√á√ïES, mas tornar transparentes os n√∫meros usados
- Identificar oportunidades ou riscos estrat√©gicos
- Usar **negrito** para palavras-chave importantes

### ‚ùå O QUE N√ÉO FAZER:
- Repetir valores que est√£o vis√≠veis no gr√°fico
- Listar dados sem interpreta√ß√£o ("A √© maior que B")
- Usar frases gen√©ricas ("distribui√ß√£o desigual")
- Mencionar mais de {max_insights} insights
- **Apresentar m√©tricas derivadas SEM mostrar os valores base do c√°lculo**

### üìã ESTRUTURA OBRIGAT√ìRIA:
Cada insight deve ter este formato:
- **T√≠tulo descritivo**: Interpreta√ß√£o com n√∫meros contextualizados (%, m√∫ltiplos, pontos percentuais) **+ valores absolutos entre par√™nteses**

### üé® EXEMPLOS DE TRANSFORMA√á√ÉO:

‚ùå ERRADO (sem valores base):
- "SC √© o maior estado"
- "Top 5 clientes respondem por 20.5% do faturamento total"
- "O 1¬∫ colocado √© 18.3% superior ao 2¬∫"

‚úÖ CORRETO (com valores base expl√≠citos):
- "**Concentra√ß√£o significativa**: SC representa 43% do total **(R\\$ 8.6M / R\\$ 20.0M)**, superando RS em +12 p.p."
- "**Concentra√ß√£o do Top 5**: Top 5 clientes respondem por 20.5% do faturamento total **(Top 5 = R\\$ 4.1M / Total = R\\$ 20.0M)**"
- "**Lideran√ßa vs 2¬∫**: O 1¬∫ colocado √© 18.3% superior ao 2¬∫ **(R\\$ 1.18M vs R\\$ 1.0M, m√∫ltiplo 1.18x)**"

---
"""

    # Adicionar diretrizes espec√≠ficas por tipo de gr√°fico
    if tipo_grafico == "horizontal_bar":
        prompt += """
### üìä FOCO PARA RANKINGS:

**‚ö†Ô∏è TRANSPAR√äNCIA OBRIGAT√ìRIA para rankings:**
Sempre incluir os valores absolutos que fundamentam cada m√©trica:

1. **Concentra√ß√£o** (top N representa X% do total) ‚Üí **Formato: "(Top N = R\\$ X / Total = R\\$ Y)"**
   - Use: `concentracao_top3_pct`, `total_topn`, `total_universo`

2. **Gap entre lideran√ßa e demais** ‚Üí **Formato: "(R\\$ X vs R\\$ Y, m√∫ltiplo Zx)"**
   - Use: `gap_1_2_pct`, `valor_max`, valores espec√≠ficos, `multiplo_1_vs_2`

3. **Desvio do l√≠der vs m√©dia** ‚Üí **Formato: "(L√≠der = R\\$ X / M√©dia = R\\$ Y)"**
   - Use: `desvio_lider_media_pct`, `valor_max`, `media`

4. **Contribui√ß√£o do l√≠der** ‚Üí **Formato: "(R\\$ X / R\\$ Y = Z%)"**
   - Use: `contribuicao_lider_pct`, `valor_max`, `total_universo`

**M√©tricas-chave dispon√≠veis**:
- `concentracao_top3_pct` / `concentracao_top5_pct`: % do total no top N
- `total_topn`: Soma do Top N exibido
- `total_universo`: Soma total do universo completo filtrado
- `gap_1_2_pct`: Diferen√ßa percentual entre 1¬∫ e 2¬∫
- `valor_max`, `valor_min`: Valores do l√≠der e √∫ltimo colocado
- `multiplo_1_vs_2`: Quantas vezes o l√≠der √© maior que o segundo
- `contribuicao_lider_pct`: Participa√ß√£o do l√≠der no total
- `desvio_lider_media_pct`: Quanto o l√≠der est√° acima da m√©dia
- `media`: M√©dia dos valores

**Exemplos de insights COMPLETOS com transpar√™ncia:**
- "**Concentra√ß√£o do Top 5**: 20.5% do faturamento total **(Top 5 = R\\$ 4.1M / Total = R\\$ 20.0M)**"
- "**Lideran√ßa vs 2¬∫**: O 1¬∫ colocado √© 18.3% superior **(R\\$ 1.18M vs R\\$ 1.0M, m√∫ltiplo 1.18x)**"
- "**Contribui√ß√£o do l√≠der**: Representa 8.4% do total de SC **(R\\$ 1.68M / R\\$ 20.0M)**"
- "**Dispers√£o do l√≠der**: 105% acima da m√©dia **(L√≠der = R\\$ 1.68M / M√©dia = R\\$ 0.82M)**"
"""

    elif tipo_grafico == "vertical_bar":
        prompt += """
### üìä FOCO PARA COMPARA√á√ïES:

**‚ö†Ô∏è TRANSPAR√äNCIA OBRIGAT√ìRIA para compara√ß√µes:**
Sempre incluir os valores absolutos que fundamentam cada m√©trica:

1. **Diferen√ßa percentual entre categorias** ‚Üí **Formato: "(R\\$ X vs R\\$ Y, diferen√ßa de Z%)"**
   - Use: `diferenca_pct`, `valor_maior`, `valor_menor`

2. **Propor√ß√µes relativas** ‚Üí **Formato: "(SC = R\\$ X / Total = R\\$ Y = Z%)"**
   - Use: `contribuicao_maior_pct`, `contribuicao_menor_pct`, valores absolutos

3. **Diferen√ßa em pontos percentuais** ‚Üí **Formato: "X% vs Y% (+Z p.p.)"**
   - Use: `diferenca_pontos_percentuais`, valores de participa√ß√£o

**M√©tricas-chave dispon√≠veis**:
- `diferenca_pct`: Diferen√ßa % entre maior e menor
- `valor_maior`, `valor_menor`: Valores absolutos das categorias
- `diferenca_pontos_percentuais`: Diferen√ßa em p.p.
- `contribuicao_maior_pct` / `contribuicao_menor_pct`: Share de cada
- `proporcao_relativa`: Propor√ß√£o formatada (ex: "60% vs 40%")
- `total_geral`: Soma total para contexto

**Exemplos de insights COMPLETOS com transpar√™ncia:**
- "**SC lidera**: 43% do total **(R\\$ 8.6M / R\\$ 20.0M)**, superando RJ em 12 p.p. **(RJ = R\\$ 6.2M / R\\$ 20.0M = 31%)**"
- "**Diferen√ßa significativa**: Maior categoria supera a menor em 58% **(R\\$ 3.2M vs R\\$ 2.0M)**"
- "**Propor√ß√£o equilibrada**: 52% vs 48% **(R\\$ 10.4M vs R\\$ 9.6M)**, indicando distribui√ß√£o uniforme"
"""

    elif tipo_grafico == "line":
        prompt += """
### üìä FOCO PARA S√âRIES TEMPORAIS:

**‚ö†Ô∏è TRANSPAR√äNCIA OBRIGAT√ìRIA para s√©ries temporais:**
Sempre incluir os valores absolutos que fundamentam cada m√©trica:

1. **Taxa de crescimento** ‚Üí **Formato: "(R\\$ X ‚Üí R\\$ Y, +Z%)"**
   - Use: `taxa_crescimento_pct`, `valor_inicial`, `valor_final`

2. **Picos e vales** ‚Üí **Formato: "(Pico: R\\$ X em [data], Vale: R\\$ Y em [data])"**
   - Use: `pico_valor`, `pico_periodo`, `vale_valor`, `vale_periodo`

3. **Amplitude** ‚Üí **Formato: "(Varia√ß√£o de R\\$ X, amplitude de Y%)"**
   - Use: `amplitude`, `amplitude_pct`

4. **Acelera√ß√£o** ‚Üí **Formato: "(H1 m√©dia R\\$ X vs H2 m√©dia R\\$ Y, +Z%)"**
   - Use: `aceleracao_segunda_metade_pct`, calcular m√©dias quando poss√≠vel

**M√©tricas-chave dispon√≠veis**:
- `tendencia`: "crescente", "decrescente" ou "est√°vel"
- `taxa_crescimento_pct`: Crescimento total do per√≠odo
- `valor_inicial`, `valor_final`: Valores de in√≠cio e fim
- `pico_valor` / `pico_periodo`: Valor m√°ximo e quando ocorreu
- `vale_valor` / `vale_periodo`: Valor m√≠nimo e quando ocorreu
- `amplitude`, `amplitude_pct`: Varia√ß√£o entre pico e vale
- `aceleracao_segunda_metade_pct`: Compara√ß√£o H1 vs H2
- `comportamento_temporal`: Padr√£o identificado
- `variacao_media_pct`: Varia√ß√£o m√©dia per√≠odo a per√≠odo

**Exemplos de insights COMPLETOS com transpar√™ncia:**
- "**Crescimento sustentado**: 32% no per√≠odo **(R\\$ 15.2M ‚Üí R\\$ 20.0M)**"
- "**Pico em julho**: R\\$ 2.5M, 18% acima da m√©dia mensal **(m√©dia = R\\$ 2.1M)**"
- "**Amplitude significativa**: Varia√ß√£o de R\\$ 1.2M **(Pico: R\\$ 2.5M em jul/15, Vale: R\\$ 1.3M em fev/15 = +92%)**"
- "**Acelera√ß√£o no H2**: Segunda metade 25% superior **(H1 m√©dia = R\\$ 1.8M vs H2 m√©dia = R\\$ 2.25M)**"
"""

    elif tipo_grafico in ["grouped_vertical_bar", "stacked_bar"]:
        prompt += """
### üìä FOCO PARA COMPARA√á√ïES AGRUPADAS:

**‚ö†Ô∏è TRANSPAR√äNCIA OBRIGAT√ìRIA para compara√ß√µes agrupadas:**
Sempre incluir os valores absolutos que fundamentam cada m√©trica:

1. **Diferen√ßas entre grupos/per√≠odos** ‚Üí **Formato: "(Mar√ßo: R\\$ X, Abril: R\\$ Y, +Z%)"**
2. **Categorias que cresceram/decresceram** ‚Üí **Formato: "(SC: R\\$ X ‚Üí R\\$ Y, +Z%)"**
3. **Mudan√ßas estruturais no mix** ‚Üí **Formato: "(Per√≠odo 1: A=X%, B=Y%; Per√≠odo 2: A=W%, B=Z%)"**
4. **Lideran√ßa por grupo** ‚Üí **Formato: "(Mar√ßo: l√≠der SC = R\\$ X; Abril: l√≠der PR = R\\$ Y)"**

**Exemplos:**
- "**Crescimento assim√©trico**: SC cresceu 25% entre mar√ßo e abril **(R\\$ 2.0M ‚Üí R\\$ 2.5M)**, enquanto PR manteve estabilidade **(R\\$ 1.8M ‚Üí R\\$ 1.85M, +2.7%)**"
- "**Mudan√ßa de lideran√ßa**: Em mar√ßo SC liderou com R\\$ 2.0M (40% do total); em abril PR assumiu com R\\$ 2.2M (42% do total)"
"""

    prompt += """
---

‚ö†Ô∏è IMPORTANTE:
- Use estas m√©tricas para ENRIQUECER a se√ß√£o de Insights da sua resposta
- NUNCA gere APENAS insights - SEMPRE inclua os 5 elementos obrigat√≥rios:
  1. ## T√≠tulo
  2. [Senten√ßa introdut√≥ria com filtros em **negrito**]
  3. [Gr√°fico autom√°tico]
  4. ### üí° Principais Insights ({max_insights} itens baseados nas m√©tricas acima)
  5. ### üîç Pr√≥ximos Passos

O gr√°fico mostra OS DADOS. Voc√™ fornece OS INSIGHTS (dentro da estrutura completa).
""".format(max_insights=max_insights)

    return prompt


def formatar_metricas_para_exibicao(resumo: Dict[str, Any]) -> str:
    """
    Formata resumo num√©rico para exibi√ß√£o leg√≠vel (√∫til para debug).
    
    Args:
        resumo: Dicion√°rio com m√©tricas
    
    Returns:
        String formatada para exibi√ß√£o
    """
    linhas = []
    linhas.append("üìä Resumo Num√©rico:")
    linhas.append(f"  - Tipo: {resumo.get('tipo_grafico', 'N/A')}")
    linhas.append(f"  - Categorias: {resumo.get('num_categorias', 0)}")
    linhas.append(f"  - Total: {resumo.get('total_geral', 0):,.0f}")
    linhas.append(f"  - M√©dia: {resumo.get('media', 0):,.0f}")

    if 'concentracao_top3_pct' in resumo:
        linhas.append(f"  - Concentra√ß√£o Top 3: {resumo['concentracao_top3_pct']}%")

    if 'gap_1_2_pct' in resumo:
        linhas.append(f"  - Gap 1¬∫ vs 2¬∫: {resumo['gap_1_2_pct']}%")

    if 'tendencia' in resumo:
        linhas.append(f"  - Tend√™ncia: {resumo['tendencia']}")

    if 'taxa_crescimento_pct' in resumo:
        linhas.append(f"  - Crescimento: {resumo['taxa_crescimento_pct']:+.1f}%")

    return '\n'.join(linhas)

